<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DSE Writing Feedback</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 40px auto; padding: 20px; }
    label { font-weight: bold; margin-top: 20px; display: block; }
    textarea, input, select, button, pre {
      width: 100%; margin-top: 5px; padding: 10px; font-size: 14px;
    }
    button { background-color: #2563eb; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #1e40af; }
    pre { background: #f9fafb; border: 1px solid #d1d5db; min-height: 80px; white-space: pre-wrap; }
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>DSE Writing Feedback Tool</h1>

  <label for="question">Writing Question</label>
  <input id="question" placeholder="e.g. Should school uniforms be mandatory?" />

  <label for="studentWriting">Your Writing</label>
  <textarea id="studentWriting" rows="10" placeholder="Paste or write your full response here..."></textarea>

  <label for="feedbackMode">Feedback Mode</label>
  <select id="feedbackMode">
    <option value="quick">Quick Feedback (C / L / O)</option>
    <option value="detailed">Detailed Feedback (with examples)</option>
    <option value="accurate">Accurate Feedback (paragraph-by-paragraph)</option>
  </select>

  <div class="grid">
    <div><label>C1<input id="C1" type="number" min="1" max="7" /></label></div>
    <div><label>L1<input id="L1" type="number" min="1" max="7" /></label></div>
    <div><label>O1<input id="O1" type="number" min="1" max="7" /></label></div>
    <div><label>C2<input id="C2" type="number" min="1" max="7" /></label></div>
    <div><label>L2<input id="L2" type="number" min="1" max="7" /></label></div>
    <div><label>O2<input id="O2" type="number" min="1" max="7" /></label></div>
  </div>

  <button onclick="generateFeedback()">Generate Feedback</button>
  <pre id="feedback">Feedback will appear here...</pre>
  <pre id="judgement">Final judgement will appear here...</pre>

  <div style="display: flex; gap: 20px; margin-top: 20px;">
    <div style="flex: 1;">
      <button onclick="brushUp('5')">Brush-up Writing to Level 5</button>
      <pre id="brushup5">Your Level 5 improved writing will appear here...</pre>
    </div>
    <div style="flex: 1;">
      <button onclick="brushUp('5**')">Brush-up Writing to Level 5**</button>
      <pre id="brushup5star">Your Level 5** improved writing will appear here...</pre>
    </div>
  </div>

<script>
  async function generateFeedback() {
    const writing = document.getElementById("studentWriting").value;
    const mode = document.getElementById("feedbackMode").value;
    const feedbackEl = document.getElementById("feedback");
    const judgementEl = document.getElementById("judgement");

    const scores = {
      C1: document.getElementById("C1").value,
      C2: document.getElementById("C2").value,
      L1: document.getElementById("L1").value,
      L2: document.getElementById("L2").value,
      O1: document.getElementById("O1").value,
      O2: document.getElementById("O2").value
    };

    let originalScores = null;
    if (scores.C1 && scores.C2 && scores.L1 && scores.L2 && scores.O1 && scores.O2) {
      originalScores = {
        C1: Number(scores.C1),
        C2: Number(scores.C2),
        L1: Number(scores.L1),
        L2: Number(scores.L2),
        O1: Number(scores.O1),
        O2: Number(scores.O2)
      };
    }

    feedbackEl.innerText = "🔄 Generating feedback...";
    judgementEl.innerText = "";

    if (mode === "accurate") {
      const paragraphs = writing.split(/\n{2,}/).filter(p => p.trim().length > 0);
      const insights = [];

      for (let i = 0; i < paragraphs.length; i++) {
        try {
          const res = await fetch("/api/bands-paragraph", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              paragraph: paragraphs[i],
              position: i === 0 ? "introduction" : i === paragraphs.length - 1 ? "conclusion" : "body"
            })
          });
          const data = await res.json();
          insights.push(data.paragraphAnalysis || `⚠️ No analysis for paragraph ${i + 1}`);
        } catch {
          insights.push(`❌ Error analyzing paragraph ${i + 1}`);
        }
      }

      try {
        const res2 = await fetch("/api/bands-summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ insights })
        });
        const data2 = await res2.json();
        feedbackEl.innerText = data2.bandAnalysis || "⚠️ No feedback summary returned.";
      } catch {
        feedbackEl.innerText = "❌ Failed to summarize band scores.";
      }
    } else {
      try {
        const res = await fetch("/api/bands", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ writing, originalScores, paperType: "Part A", mode })
        });
        const data = await res.json();
        const bandText = data.bandAnalysis || "⚠️ No feedback returned.";
        feedbackEl.innerText = bandText;

        const matchBands = bandText.match(/Band Scores:\s*C:\s*(\d).*?L:\s*(\d).*?O:\s*(\d)/s);
        const bands = matchBands ? [parseInt(matchBands[1]), parseInt(matchBands[2]), parseInt(matchBands[3])] : [];

        if (bands.length === 3) {
          judgementEl.innerText = "🔄 Calculating final level and suggestions...";
          const res2 = await fetch("/api/judgement", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ writing, bands })
          });

          const data2 = await res2.json();
          judgementEl.innerText = data2.judgement || "⚠️ No judgement returned.";
        } else {
          judgementEl.innerText = "⚠️ Could not extract all three band scores for final judgement.";
        }
      } catch {
        feedbackEl.innerText = "❌ Server error during feedback.";
      }
    }
  }

  async function brushUp(level = "5**") {
    const writing = document.getElementById("studentWriting").value;
    const outputBox = level === "5" ? document.getElementById("brushup5") : document.getElementById("brushup5star");
    outputBox.innerText = "";

    const paragraphs = writing.split(/\n{2,}/).filter(p => p.trim().length > 0);

    for (let i = 0; i < paragraphs.length; i++) {
      outputBox.innerText += `\n🔄 Rewriting paragraph ${i + 1} to Level ${level}...\n`;
      try {
        const response = await fetch("/api/rewrite", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ paragraph: paragraphs[i], level })
        });

        const data = await response.json();
        outputBox.innerText += data.rewritten || "⚠️ Rewrite failed.";
        outputBox.innerText += "\n\n";
      } catch {
        outputBox.innerText += "❌ Server error.\n\n";
      }
    }
  }
</script>
</body>
</html>
